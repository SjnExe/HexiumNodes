name: Build Android App

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - dev
  workflow_dispatch:
    # Manual trigger for creating dev builds on demand

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    env:
      GRADLE_OPTS: "--enable-native-access=ALL-UNNAMED -Djava.awt.headless=true"
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Calculate Version
        id: version
        run: |
          # Fetch tags for versioning
          git fetch --tags --force

          # Get latest stable tag (e.g. v1.4.6 -> 1.4.6) or default to 0.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION_BASE=${LATEST_TAG#v}
          # Subtract 1 from commit count as per user request to fix off-by-one error
          RAW_COUNT=$(git rev-list --count HEAD)
          COMMIT_COUNT=$((RAW_COUNT - 1))

          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Stable Release from Tag (e.g. 1.4.6)
            VERSION_NAME=${GITHUB_REF#refs/tags/v}
            VERSION_CODE=$COMMIT_COUNT
            IS_STABLE=true
            echo "Building Stable Release: $VERSION_NAME ($VERSION_CODE)"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PR Dev Build (e.g. 1.4.6-dev-PR9.34)
            PR_NUMBER=${{ github.event.pull_request.number }}
            RAW_PR_COMMITS=$(git rev-list --count origin/${{ github.base_ref }}..HEAD)
            PR_COMMITS=$((RAW_PR_COMMITS - 1))
            if [ $PR_COMMITS -lt 0 ]; then PR_COMMITS=0; fi
            VERSION_NAME="${VERSION_BASE}-dev-PR${PR_NUMBER}.${PR_COMMITS}"
            VERSION_CODE=$COMMIT_COUNT
            IS_STABLE=false
            echo "Building PR Dev Build: $VERSION_NAME ($VERSION_CODE)"
          else
            # Manual or Push to Dev (e.g. 1.4.6-dev-run42)
            RUN_NUMBER=${{ github.run_number }}
            VERSION_NAME="${VERSION_BASE}-dev-run${RUN_NUMBER}"
            VERSION_CODE=$COMMIT_COUNT
            IS_STABLE=false
            echo "Building Manual Dev Build: $VERSION_NAME"
          fi

          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "IS_STABLE=$IS_STABLE" >> $GITHUB_OUTPUT

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-disabled: false
          cache-read-only: false

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          IS_STABLE: ${{ steps.version.outputs.IS_STABLE }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > keystore.jks
            echo "STORE_FILE=$(pwd)/keystore.jks" >> $GITHUB_ENV
          elif [ "$IS_STABLE" == "true" ]; then
            echo "::error::Stable build triggered but KEYSTORE_BASE64 secret is missing!"
            exit 1
          else
            echo "Keystore secret missing. Generating temporary debug keystore for Dev build..."
            keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
            echo "Using generated debug.keystore for signing."
          fi

      - name: Build and Verify
        id: build
        env:
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          VERSION_NAME: ${{ steps.version.outputs.VERSION_NAME }}
          VERSION_CODE: ${{ steps.version.outputs.VERSION_CODE }}
          IS_STABLE: ${{ steps.version.outputs.IS_STABLE }}
        run: |
          set -o pipefail

          if [ "$IS_STABLE" == "true" ]; then
            # Build Stable Release (AAB & APK) + Lint/Test
            ./gradlew lintDevDebug testDevDebug bundleStableRelease assembleStableRelease \
              -PversionCode=$VERSION_CODE \
              -PversionName="$VERSION_NAME" 2>&1 | tee build_stable.log
          else
            # Build Dev Flavor (Release & Debug APKs) + Lint/Test
            # We build Release to test minification, and Debug for debugging features
            ./gradlew lintDevDebug testDevDebug assembleDevRelease assembleDevDebug \
              -PversionCode=$VERSION_CODE \
              -PversionName="$VERSION_NAME" 2>&1 | tee build_dev.log

            # Rename artifacts to generic names for easier upload/release
            # Ensure output directories exist first to avoid errors
            mkdir -p app/build/outputs/apk/dev/release
            mkdir -p app/build/outputs/apk/dev/debug

            # Use find to locate and move, ignoring if file is already named correctly
            find app/build/outputs/apk/dev/release -name "*.apk" ! -name "app-dev-release.apk" -exec mv {} app/build/outputs/apk/dev/release/app-dev-release.apk \;
            find app/build/outputs/apk/dev/debug -name "*.apk" ! -name "app-dev-debug.apk" -exec mv {} app/build/outputs/apk/dev/debug/app-dev-debug.apk \;
          fi

      - name: Generate Summary Log
        if: always()
        run: |
          SUMMARY_FILE="build_summary.txt"
          touch $SUMMARY_FILE
          echo "=== BUILD SUMMARY for ${{ steps.version.outputs.VERSION_NAME }} ===" >> $SUMMARY_FILE
          echo "Date: $(date)" >> $SUMMARY_FILE
          echo "Ref: ${{ github.ref }}" >> $SUMMARY_FILE
          echo "Commit: ${{ github.sha }}" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE

          # Function to grep errors with context
          extract_errors() {
            local log_file=$1
            if [ -f "$log_file" ]; then
              echo "--- ERROR ANALYSIS: $log_file ---" >> $SUMMARY_FILE
              # Capture lines containing 'error', 'failed', 'exception' with context
              # Exclude task execution lines unless they failed
              grep -i -E "(error|failed|exception|fatal)" -C 5 "$log_file" >> $SUMMARY_FILE || echo "No explicit error keywords found." >> $SUMMARY_FILE
              echo "" >> $SUMMARY_FILE
            fi
          }

          extract_errors "build_stable.log"
          extract_errors "build_dev.log"

          echo "=== END SUMMARY ===" >> $SUMMARY_FILE

      - name: Upload Summary Log
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: build-summary
          path: build_summary.txt

      - name: Upload Lint & Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: lint-test-results
          path: |
            **/build/reports/lint-results-*.html
            **/build/reports/tests/**/index.html
            build_dev.log
            build_stable.log

      - name: Upload APKs (Dev)
        if: steps.version.outputs.IS_STABLE == 'false'
        uses: actions/upload-artifact@v6
        with:
          name: app-dev-${{ steps.version.outputs.VERSION_NAME }}
          path: |
            app/build/outputs/apk/dev/release/app-dev-release.apk
            app/build/outputs/apk/dev/debug/app-dev-debug.apk
          compression-level: 0

      - name: Upload Bundle & APK (Stable)
        if: steps.version.outputs.IS_STABLE == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: app-stable-${{ steps.version.outputs.VERSION_NAME }}
          path: |
            app/build/outputs/bundle/stableRelease/*.aab
            app/build/outputs/apk/stable/release/*.apk
          compression-level: 0

      - name: Create/Update Dev Release
        if: steps.version.outputs.IS_STABLE == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION_NAME: ${{ steps.version.outputs.VERSION_NAME }}
        run: |
          # Delete existing 'dev' tag and release to keep it floating
          gh release delete dev --cleanup-tag -y || true

          # Create new Dev Release
          # Use "dev" as tag name, but title includes version
          gh release create dev \
            app/build/outputs/apk/dev/release/app-dev-release.apk \
            app/build/outputs/apk/dev/debug/app-dev-debug.apk \
            --title "Development Build $VERSION_NAME" \
            --notes "Development build triggered by ${{ github.event_name }}. Version: $VERSION_NAME" \
            --prerelease \
            --target ${{ github.sha }}

      - name: Create Stable Release
        if: steps.version.outputs.IS_STABLE == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }} # Uses the pushed tag (e.g. v1.4.6)
          name: Release ${{ steps.version.outputs.VERSION_NAME }}
          files: |
            app/build/outputs/bundle/stableRelease/*.aab
            app/build/outputs/apk/stable/release/*.apk
          draft: false
          prerelease: false
