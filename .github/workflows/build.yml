name: Build Android App

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - dev
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Flavor to build'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - stable

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      VERSION_NAME: ${{ steps.version.outputs.VERSION_NAME }}
      VERSION_CODE: ${{ steps.version.outputs.VERSION_CODE }}
      IS_STABLE: ${{ steps.version.outputs.IS_STABLE }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate Version
        id: version
        run: |
          # Fetch tags
          git fetch --tags --force

          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION_BASE=${LATEST_TAG#v}
          COMMIT_COUNT=$(git rev-list --count HEAD)

          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Stable Release from Tag
            VERSION_NAME=${GITHUB_REF#refs/tags/v}
            VERSION_CODE=$COMMIT_COUNT
            IS_STABLE=true
            echo "Building Stable Release: $VERSION_NAME ($VERSION_CODE)"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PR Build
            PR_NUMBER=${{ github.event.pull_request.number }}
            PR_COMMITS=$(git rev-list --count origin/${{ github.base_ref }}..HEAD)
            VERSION_NAME="${VERSION_BASE}-beta-PR${PR_NUMBER}.${PR_COMMITS}"
            VERSION_CODE=$COMMIT_COUNT
            IS_STABLE=false
            echo "Building PR Dev Build: $VERSION_NAME ($VERSION_CODE)"
          else
            # Manual or Push to Dev
            RUN_NUMBER=${{ github.run_number }}
            VERSION_NAME="${VERSION_BASE}-beta-run${RUN_NUMBER}"
            VERSION_CODE=$COMMIT_COUNT
            IS_STABLE=false
            if [[ "${{ inputs.flavor }}" == "stable" ]]; then
               IS_STABLE=true
               echo "Building Manual Stable Build: $VERSION_NAME"
            else
               echo "Building Manual Dev Build: $VERSION_NAME"
            fi
          fi

          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "IS_STABLE=$IS_STABLE" >> $GITHUB_OUTPUT

  lint:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Lint
        env:
          VERSION_NAME: ${{ needs.setup.outputs.VERSION_NAME }}
          VERSION_CODE: ${{ needs.setup.outputs.VERSION_CODE }}
        run: ./gradlew lint

      - name: Unit Tests
        env:
          VERSION_NAME: ${{ needs.setup.outputs.VERSION_NAME }}
          VERSION_CODE: ${{ needs.setup.outputs.VERSION_CODE }}
        run: ./gradlew testDevDebugUnitTest

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-test-reports
          path: |
            app/build/reports/lint-results-*.html
            app/build/reports/tests/test*UnitTest/index.html

  build:
    runs-on: ubuntu-latest
    needs: [setup, lint]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          IS_STABLE: ${{ needs.setup.outputs.IS_STABLE }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > keystore.jks
            echo "STORE_FILE=$(pwd)/keystore.jks" >> $GITHUB_ENV
          elif [ "$IS_STABLE" == "true" ]; then
            echo "::error::Stable build triggered but KEYSTORE_BASE64 secret is missing!"
            exit 1
          else
            echo "Keystore secret missing. Generating temporary debug keystore for Dev build..."
            keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
            echo "Using generated debug.keystore for signing."
          fi

      - name: Build Dev Flavor
        if: needs.setup.outputs.IS_STABLE == 'false'
        env:
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          VERSION_NAME: ${{ needs.setup.outputs.VERSION_NAME }}
          VERSION_CODE: ${{ needs.setup.outputs.VERSION_CODE }}
        run: |
          ./gradlew assembleDevRelease assembleDevDebug \
            -PversionCode=$VERSION_CODE \
            -PversionName="$VERSION_NAME" > build_dev.log 2>&1 || (cat build_dev.log && exit 1)

      - name: Build Stable Flavor
        if: needs.setup.outputs.IS_STABLE == 'true'
        env:
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          VERSION_NAME: ${{ needs.setup.outputs.VERSION_NAME }}
          VERSION_CODE: ${{ needs.setup.outputs.VERSION_CODE }}
        run: |
          ./gradlew bundleStableRelease assembleStableRelease \
            -PversionCode=$VERSION_CODE \
            -PversionName="$VERSION_NAME" > build_stable.log 2>&1 || (cat build_stable.log && exit 1)

      - name: Generate Short Logs
        if: always()
        run: |
          for log in build_*.log; do
            if [ -f "$log" ]; then
              echo "--- HEAD ---" > "${log}.short.txt"
              head -n 100 "$log" >> "${log}.short.txt"
              echo "--- TAIL ---" >> "${log}.short.txt"
              tail -n 100 "$log" >> "${log}.short.txt"
            fi
          done

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            *.log
            *.short.txt

      - name: Upload APKs (Dev)
        if: needs.setup.outputs.IS_STABLE == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: app-dev-${{ needs.setup.outputs.VERSION_NAME }}
          path: |
            app/build/outputs/apk/dev/release/*.apk
            app/build/outputs/apk/dev/debug/*.apk

      - name: Upload Bundle & APK (Stable)
        if: needs.setup.outputs.IS_STABLE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: app-stable-${{ needs.setup.outputs.VERSION_NAME }}
          path: |
            app/build/outputs/bundle/stableRelease/*.aab
            app/build/outputs/apk/stable/release/*.apk

  test_arm:
    runs-on: ubuntu-latest
    needs: build
    if: needs.setup.outputs.IS_STABLE == 'false'
    steps:
      - name: Placeholder for ARM64 Tests
        run: echo "Skipping ARM64 tests as no runner is configured yet."

  release:
    runs-on: ubuntu-latest
    needs: [setup, build]
    permissions:
      contents: write
    steps:
      - name: Download Artifacts (Stable)
        if: needs.setup.outputs.IS_STABLE == 'true'
        uses: actions/download-artifact@v4
        with:
          name: app-stable-${{ needs.setup.outputs.VERSION_NAME }}
          path: artifacts/stable

      - name: Create GitHub Release (Stable)
        if: needs.setup.outputs.IS_STABLE == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.setup.outputs.VERSION_NAME }}
          name: Release ${{ needs.setup.outputs.VERSION_NAME }}
          files: |
            artifacts/stable/*.apk
            artifacts/stable/*.aab
          draft: false
          prerelease: false

      - name: Download Artifacts (Dev)
        if: needs.setup.outputs.IS_STABLE == 'false' && github.event_name != 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: app-dev-${{ needs.setup.outputs.VERSION_NAME }}
          path: artifacts/dev

      - name: Delete Old Dev Tag
        if: needs.setup.outputs.IS_STABLE == 'false' && github.event_name != 'pull_request'
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          tag_name: dev
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Dev Release
        if: needs.setup.outputs.IS_STABLE == 'false' && github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: dev
          name: Development Build ${{ needs.setup.outputs.VERSION_NAME }}
          files: |
            artifacts/dev/*.apk
          draft: false
          prerelease: true
